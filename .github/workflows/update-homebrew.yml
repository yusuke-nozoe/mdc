name: Update Homebrew Formula
on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: zoetin45/homebrew-mdc
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update Formula
        run: |
          # リリース情報を取得
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # v を削除
          
          # ダウンロードURLとSHA256を取得
          INTEL_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/mdc_${VERSION}_x64.dmg"
          ARM_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/mdc_${VERSION}_aarch64.dmg"
          
          # SHA256を計算（実際のファイルから）
          INTEL_SHA=$(curl -sL $INTEL_URL | shasum -a 256 | cut -d' ' -f1)
          ARM_SHA=$(curl -sL $ARM_URL | shasum -a 256 | cut -d' ' -f1)
          
          # Formulaを更新
          sed -i "s/version \".*\"/version \"$VERSION\"/" Formula/mdc.rb
          sed -i "s|url \".*_x64\.dmg\"|url \"$INTEL_URL\"|" Formula/mdc.rb
          sed -i "s|url \".*_aarch64\.dmg\"|url \"$ARM_URL\"|" Formula/mdc.rb
          # SHA256も同様に更新

      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Update to version ${{ github.event.release.tag_name }}"
          git push
